<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" type="text/css" href="http://blog.dasroot.net/theme/css/semantic.min.css">
  <link rel="stylesheet" type="text/css" href="http://blog.dasroot.net/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="http://blog.dasroot.net/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>


  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Charles Butler">
  <meta name="description" content="Posts and writings by Charles Butler">

  <link href="http://blog.dasroot.net/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Chuck@Home Atom" />
<meta name="keywords" content="juju, networking, planet, flannel, lxc">

  <title>
    Chuck@Home
&ndash; Container Networking with Flannel  </title>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-29116636-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="http://blog.dasroot.net">
        <img src="http://www.gravatar.com/avatar/78270a8df5051560ab56ad16bc4724a3.png?s=200" alt="Chuck@home" class="ui medium circular image">
      </a>
      <h2><a href="http://blog.dasroot.net">Chuck@Home</a></h2>
      <p>juju deploy happiness</p>
      <ul>
        <li><a href="http://charlesbutler.me/" target="_blank">About Chuck</a></li>
        <li><a href="http://blog.juju.solutions/" target="_blank">My GPG Key</a></li>
        <li><a href="http://blog.dasroot.net/archives" target="_blank">Archives</a></li>
        <li><a href="http://github.com/chuckbutler" target="_blank">Github</a></li>
        <li><a href="http://twitter.com/lazypower" target="_blank">Twitter</a></li>
        <li><a href="https://plus.google.com/+CharlesButlertheNinja" target="_blank">Google+</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="http://blog.dasroot.net">Index</a> &brvbar; <a href="http://blog.dasroot.net/archives.html">Archives</a>
      &brvbar; <a href="http://blog.dasroot.net/feeds/all.atom.xml">Atom</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h3><a href="http://blog.dasroot.net/container-networking-with-flannel.html">Container Networking with Flannel</a></h3>
  </div>
  <div class="article_text">
    <hr />
<p><iframe width="560" height="315" src="//www.youtube.com/embed/bCvl-TsxVXA" frameborder="0" allowfullscreen></iframe></p>
<p>When leveraging juju with LXC in cloud environments - networking has been a constant thorn in my side as I attempt to scale out farms of services in their full container glory. Thanks to the work by <a href="http://blog.kapilt.com/">Hazmat</a> (who brought us the Digital Ocean Provider) - there is a new development in this sphere ready for testing over this holiday season.</p>
<h3>Container Networking with Juju in the cloud</h3>
<p>Juju by default supports colocating services with LXC containers and KVM machines. LXC is all the rage these days, as linux containers are light weight kernel virtualized cgroups. Akin to BSD Jails - but not quite. Its a awesome solution where you dont care about resource isolation, and Just want your application to run within its own happy root, and live on churning away at whatever you might throw at it.</p>
<p>While this is great - it has a major achilles tendon presently in the Juju sphere. Cross-host communication is all but non-existant. In order to really scale and use LXC containers you need a beefy host to warehouse all the containers you can stuff on its disk. This isn't practical in scale out situations where your needs change on a day to day basis. You wind up losing out on the benefits of commodity hardware.  </p>
<p>Flannel knocks this restriction out with great justice. Allow me to show you how:</p>
<h3>Model Density Deployments with Juju and LXC</h3>
<p>I'm going to assume you've done a few things.</p>
<ul>
<li>Have a bootstrapped environment</li>
<li>Have at least 3 machines available to you</li>
</ul>
<p>Start off by deploying Etcd and Flannel</p>
<div class="highlight"><pre><span class="n">juju</span> <span class="n">deploy</span> <span class="n">cs</span><span class="o">:~</span><span class="n">hazmat</span><span class="o">/</span><span class="n">trusty</span><span class="o">/</span><span class="n">etcd</span>
<span class="n">juju</span> <span class="n">deploy</span> <span class="n">cs</span><span class="o">:~</span><span class="n">hazmat</span><span class="o">/</span><span class="n">trusty</span><span class="o">/</span><span class="n">flannel</span>
<span class="n">juju</span> <span class="n">add</span><span class="o">-</span><span class="n">unit</span> <span class="n">flannel</span>
<span class="n">juju</span> <span class="n">add</span><span class="o">-</span><span class="n">relation</span> <span class="n">flannel</span> <span class="n">etcd</span>
</pre></div>


<blockquote>
<p><strong>Important!</strong> You must wait for the flannel units to have completed their setup run before you deploy any lxc containers to the host. Otherwise you will be racing the virtual device setup, and this may misconfigure the networking.</p>
</blockquote>
<p>With Flannel and Etcd running, you're now ready to deploy your services in LXC containers. Assuming the Flannel machine's provisioned by Juju are machineid 2, and 3:</p>
<div class="highlight"><pre><span class="n">juju</span> <span class="n">deploy</span> <span class="n">cs</span><span class="o">:</span><span class="n">trusty</span><span class="o">/</span><span class="n">mediawiki</span> <span class="o">--</span><span class="n">to</span> <span class="n">lxc</span><span class="o">:</span><span class="mi">2</span>
<span class="n">juju</span> <span class="n">deploy</span> <span class="n">cs</span><span class="o">:</span><span class="n">trusty</span><span class="o">/</span><span class="n">mysql</span> <span class="o">--</span><span class="n">to</span> <span class="n">lxc</span><span class="o">:</span><span class="mi">3</span>
<span class="n">juju</span> <span class="n">deploy</span> <span class="n">cs</span><span class="o">:</span><span class="n">trusty</span><span class="o">/</span><span class="n">haproxy</span> <span class="o">--</span><span class="n">to</span> <span class="mi">2</span>
<span class="n">juju</span> <span class="n">add</span><span class="o">-</span><span class="n">relation</span> <span class="n">mediawiki</span><span class="o">:</span><span class="n">db</span> <span class="n">mysql</span><span class="o">:</span><span class="n">db</span>
<span class="n">juju</span> <span class="n">add</span><span class="o">-</span><span class="n">relation</span> <span class="n">mediawiki</span> <span class="n">haproxy</span>
</pre></div>


<blockquote>
<p><strong>Note</strong> We deployed haproxy to the host, and not to an LXC container. This is to provide access to the containerized services from the public interface - flannel only solves cross-host private networking with the containers.</p>
</blockquote>
<p>This may take a short while to complete, as the LXC containers are fetching cloud images, and generating templates just like the Juju local provider workflow. Typically this is done in a couple minutes.</p>
<p>Once everything is online and ready for inspection, open a web-browser pointed at your Haproxy public ip, and you should see a fresh installation of Mediawiki.</p>
<p>Happy hacking!</p>
  </div>
  <div class="article_meta">
    <p>Posted on: Tue 16 December 2014</p>
    <p>Category: <a href="http://blog.dasroot.net/category/misc.html">misc</a>
 &ndash; Tags:
      <a href="http://blog.dasroot.net/tag/juju.html">juju</a>,      <a href="http://blog.dasroot.net/tag/networking.html">networking</a>,      <a href="http://blog.dasroot.net/tag/planet.html">planet</a>,      <a href="http://blog.dasroot.net/tag/flannel.html">flannel</a>,      <a href="http://blog.dasroot.net/tag/lxc.html">lxc</a>    </p>
  </div>

  <div id="commentswrap">
      <div id="comments"></div>
  </div>
  
    <script src="https://apis.google.com/js/plusone.js"></script>
    <script>
        $(document).ready(function () {
            gapi.comments.render('comments', {
                href: window.location,
                width: '600',
                first_party_property: 'BLOGGER',
                view_type: 'FILTERED_POSTMOD'
            });
    });
    </script>



</article>


    <div id="ending_message">
      <p>&copy; Charles Butler. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Charles Butler on <a href="https://github.com/chuckbutler/pelican-svbremix" target="_blank">github</a>. Member of the <a href="http://internetdefenseleague.org">Internet Defense League</a>.</p>
    </div>
  </main>
<script type="text/javascript">
  window._idl = {};
  _idl.variant = "banner";
  (function() {
    var idl = document.createElement('script');
    idl.type = 'text/javascript';
    idl.async = true;
    idl.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'members.internetdefenseleague.org/include/?url=' + (_idl.url || '') + '&campaign=' + (_idl.campaign || '') + '&variant=' + (_idl.variant || 'banner');
    document.getElementsByTagName('body')[0].appendChild(idl);
  })();
</script>
</body>
</html>